name: Security

on:
    workflow_call:
        inputs:
            use-node-version:
                description: The nodeJS version, default to "latest".
                required: false
                default: "latest"
                type: string
            use-scan-mode:
                description: The selected mode, available are "code", "dependencies" or "all", default to "all".
                required: false
                default: "all"
                type: string
            use-snyk-organization:
                description: The Snyk organization on which project is managed.
                required: true
                type: string
            use-snyk-project:
                description: The Snyk project on which reports will be uploaded.
                required: true
                type: string
            target:
                description: The target identifier, like a git branch, default to "main".
                required: false
                default: "main"
                type: string
            severity-threshold:
                description: The severity threshold, can be "low", "medium", "high", "critical" or a combination of them, default to "low|medium|high|critical"
                required: false
                default: "low|medium|high|critical"
                type: string
            fail-on:
                description: The "fail" strategy, available are "upgradable", "patchable" or "all", default to "upgradable".
                required: false
                type: string
        secrets:
            github-token:
                description: The Github token with "repository viewer" access.
                required: true
            snyk-token:
                description: The Snyk token. Please 
                required: true
        
jobs:
    scan-code:
        runs-on: ubuntu-latest
        name: Scan code for vulnerabilities
        if: ${{ contains(fromJSON('["all", "code"]'), inputs.use-scan-mode) }}
        steps:
            - id: checkout-code
              name: Initialize code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.github-token }}
            - id: setup-node
              name: Initialize NodeJS
              uses: actions/setup-node@v4
              with:
                node-version: ${{ inputs.use-node-version }}
                cache: "npm"
            - id: setup-snyk
              name: Initialize Snyk CLI
              run: |
                npm install -g snyk
                snyk auth ${{ secrets.snyk-token }}
            - id: scan-code
              name: Scan code for vulnerabilities
              run: |
                snyk code test \
                    -d \
                    --report \
                    --org="${{ inputs.use-snyk-organization }}" \
                    --project-name="${{ inputs.use-snyk-project }}" \
                    --target-name="${{ inputs.target }}" \
                    --severity-threshold="${{ inputs.severity-threshold }}" >> $GITHUB_STEP_SUMMARY
    scan-dependencies:
        runs-on: ubuntu-latest
        name: Scan dependencies for vulnerabilities
        if: ${{ contains(fromJSON('["all", "dependencies"]'), inputs.use-scan-mode) }}
        steps:
            - id: checkout-code
              name: Initialize code
              uses: actions/checkout@v4
              with:
                token: ${{ secrets.github-token }}
            - id: setup-node
              name: Initialize NodeJS
              uses: actions/setup-node@v4
              with:
                node-version: ${{ inputs.use-node-version }}
                cache: "npm"
            - id: setup-snyk
              name: Initialize Snyk CLI
              run: |
                npm install -g snyk
                snyk auth ${{ secrets.snyk-token }}
            - id: scan-code
              name: Scan dependencies for vulnerabilities
              run: |
                snyk test \
                    -d \
                    --report \
                    --org="${{ inputs.use-snyk-organization }}" \
                    --project-name="${{ inputs.use-snyk-project }}" \
                    --target-name="${{ inputs.target }}" \
                    --severity-threshold="${{ inputs.severity-threshold }}" 
                    --fail-on="${{ inputs.fail-on }}" >> $GITHUB_STEP_SUMMARY
        